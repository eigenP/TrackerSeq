name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0} # critical for conda activation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Optional but recommended: cache conda pkgs
      - name: Cache conda packages
        uses: actions/cache@v4
        with:
          path: ~/.conda/pkgs
          key: ${{ runner.os }}-conda-${{ hashFiles('environment.yml') }}

      - name: Set up Miniforge (Python 3.9)
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-variant: Miniforge3
          use-mamba: true
          environment-file: environment.yml
          activate-environment: ci-env
          auto-activate-base: false

      - name: Debug environment
        run: |
          which python
          python --version
          conda list

      - name: Install Bartender 1.1
        run: |
          # Clone and compile Bartender
          git clone https://github.com/LaoZZZZZ/bartender-1.1.git
          cd bartender-1.1
          make

          # Install binaries to a location in PATH (using Conda's bin for convenience)
          # $CONDA_PREFIX/bin is active because of shell: bash -l {0}
          echo "Installing bartender binaries to $CONDA_PREFIX/bin"
          cp bartender_single* $CONDA_PREFIX/bin/

          # cleanup
          cd ..
          rm -rf bartender-1.1

      - name: Verify external dependencies
        run: |
          samtools --version
          # bbmap package provides bbduk.sh. Version output goes to stderr.
          bbduk.sh --version || true
          # bartender check.
          if command -v bartender_single_com &> /dev/null; then
              bartender_single_com --help | head -n 10
          elif command -v bartender &> /dev/null; then
              bartender --help | head -n 10
          else
              echo "Bartender not found!"
              exit 1
          fi
          java -version

      - name: Run test suite
        run: |
          pytest -v --disable-warnings
